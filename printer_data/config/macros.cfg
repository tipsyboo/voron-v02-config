#####################################################################
# Macros
#####################################################################

[gcode_macro _INITIALIZE_MACRO_VARS]
variable_caselight_on: True
gcode:

[delayed_gcode turn_off_fan]
gcode:
    M107

[gcode_macro TOGGLE_CASELIGHT]
description: Toggles the caselight LED on/off
gcode:
    {% if printer["gcode_macro _INITIALIZE_MACRO_VARS"].caselight_on %}
        # The caselight is currently ON (variable_caselight_on is True), so turn it OFF
        SET_LED LED=caselight WHITE=0
        SET_GCODE_VARIABLE MACRO=_INITIALIZE_MACRO_VARS VARIABLE=caselight_on VALUE=False
    {% else %}
        # The caselight is currently OFF (variable_caselight_on is False), so turn it ON
        SET_LED LED=caselight WHITE=0.1
        SET_GCODE_VARIABLE MACRO=_INITIALIZE_MACRO_VARS VARIABLE=caselight_on VALUE=True
    {% endif %}


[gcode_macro PRINT_START]
gcode:
    # 1. Catch the variables from your Slicer
    {% set target_bed = params.BED|int %}
    {% set target_extruder = params.EXTRUDER|int %}
    {% set target_chamber = params.CHAMBER|default("0")|int %}

    # 2. Preheat bed and nozzle for probing
    # The bed must fully heat for thermal expansion. Nozzle stays at 150C to prevent oozing while tapping.
    M140 S{target_bed}         ; Start heating bed
    M104 S150                  ; Start heating nozzle to 150C
    M190 S{target_bed}         ; Wait for bed to reach target temp
    M109 S150                  ; Wait for nozzle to reach 150C

    # 3. Home all axes (Bed is now expanded, nozzle is warm and clean)
    G28
    
    # 4. Clear any old meshes and run Klipper's native adaptive mesh
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE ADAPTIVE=1

    # 5. Park near the print to catch ooze during final heating
    # (SMART_PARK is a KAMP command that parks exactly where the purge will start)
    SMART_PARK

    # 6. Heat nozzle to final print temperature
    M109 S{target_extruder}    ; wait for extruder temp to reach final target

    # 7. KAMP Adaptive Purge
    LINE_PURGE
   
[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customize for your slicer of choice
gcode:
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-6.0 F3600                 ; retract filament
    G91                            ; relative positioning

    #   Get Boundaries
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

    #   Check end position to determine safe direction to move
    {% if printer.toolhead.position.x < (max_x - 20) %}
        {% set x_safe = 20.0 %}
    {% else %}
        {% set x_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.y < (max_y - 20) %}
        {% set y_safe = 20.0 %}
    {% else %}
        {% set y_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.z < (max_z - 2) %}
        {% set z_safe = 2.0 %}
    {% else %}
        {% set z_safe = max_z - printer.toolhead.position.z %}
    {% endif %}

    G0 Z{z_safe} F3600             ; move nozzle up
    G0 X{x_safe} Y{y_safe} F20000  ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    # M107                           ; turn off fan
    M106 S255                        ; blast part cooling fan to cool nozzle
    UPDATE_DELAYED_GCODE ID=turn_off_fan DURATION=100 ; schedule fan shutoff
    G90                            ; absolute positioning
    # G0 X60 Y{max_y-10} F3600       ; park nozzle at rear
    G0 Z{max_z-10} F3000           ; drop bed down to 10mm above the physical bottom

[gcode_macro LOAD_FILAMENT]
description: Loads new filament into toolhead
gcode:
  {% set EXTRUDER_TEMP = params.TEMP|default(220)|int %}
  M104 S150                  ; Start heating nozzle to 150C
  CHOME
  G90                         ; absolute positioning
  M109 S{EXTRUDER_TEMP}       ; heat up the hotend
  M83                         ; set extruder to relative mode
  M104 S150                   ; Start heating nozzle to 150C
  G1 X5 Y65 Z0.8 F5000.0 E15
  G1 X115 Y65 Z0.8 F250 E100
  G1 E-3 F3600
  G1 X80 Y60 Z10 F10000
  M400                        ; wait for moves to finish
  G1 E-6.0 F3600              ; retract filament
  M104 S0                     ; cool down the hotend
  M106 S255                   ; turn on part cooling fans to 100%
  G4 P30000                   ; wait for 30 seconds
  M107                        ; turn the fans back off
  CENTER

[gcode_macro UNLOAD_FILAMENT]
description: Unloads filament from toolhead
gcode:
  {% set EXTRUDER_TEMP = params.TEMP|default(220)|int %}
  M104 S150                  ; Start heating nozzle to 150C
  CHOME
  M104 S{EXTRUDER_TEMP}       ; heat up the hotend and continue
  G90                         ; absolute positioning
  M109 S{EXTRUDER_TEMP}       ; heat up the hotend
  M83                         ; set extruder to relative mode
  G1 E-5 F1800               ; quickly retract a small amount to elimate stringing
  G4 P200                     ; pause for a short amount of time
  G1 E-100 F300               ; retract slowly the rest of the way
  M400                        ; wait for moves to finish
  M104 S0                     ; cool down the hotend
  CENTER